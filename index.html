<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ESP32 Control Panel</title>
  <style>
    :root{--bg:#0b1020;--card:#111833;--muted:#93a4c7;--text:#e8eeff;--accent:#6aa9ff;--good:#3ddc97;--bad:#ff6a6a}
    *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;padding:0}
    body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:var(--text);min-height:100vh;padding:20px}
    .container{max-width:1200px;margin:0 auto}
    .card{background:rgba(255,255,255,.95);border-radius:20px;padding:30px;box-shadow:0 20px 60px rgba(0,0,0,.3);backdrop-filter:blur(10px)}
    .hidden{display:none}
    
    /* LOGIN */
    .login-container{max-width:400px;margin:100px auto}
    h2{color:#2563eb;text-align:center;margin-bottom:10px;font-size:28px}
    .subtitle{text-align:center;color:#64748b;margin-bottom:25px;font-size:14px}
    .input-group{margin-bottom:15px}
    input[type="email"],input[type="password"]{width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:10px;font-size:16px;transition:border-color .3s}
    input[type="email"]:focus,input[type="password"]:focus{outline:none;border-color:#3b82f6}
    button{padding:12px;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;transition:all .3s}
    .btn-primary{width:100%;background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);color:white;margin-top:10px}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(59,130,246,.4)}
    .btn-secondary{width:100%;background:white;color:#3b82f6;border:2px solid #3b82f6;margin-top:10px}
    .btn-secondary:hover{background:#f0f9ff}
    .error{color:#ef4444;font-size:14px;margin-top:10px;text-align:center}
    
    /* HEADER */
    .header{text-align:center;margin-bottom:30px}
    .header h2{color:white;font-size:32px;text-shadow:0 2px 10px rgba(0,0,0,.2)}
    .user-info{background:rgba(255,255,255,.2);backdrop-filter:blur(10px);color:white;padding:15px 20px;border-radius:15px;margin-top:15px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
    .user-info .device-select{display:flex;align-items:center;gap:10px}
    .user-info input{width:150px;padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.3);background:rgba(255,255,255,.2);color:white;font-size:14px}
    .user-info input::placeholder{color:rgba(255,255,255,.7)}
    .btn-logout{padding:8px 20px;background:rgba(255,255,255,.3);color:white;font-size:14px}
    .btn-logout:hover{background:rgba(255,255,255,.4);transform:none}
    
    /* GRID */
    .grid{display:grid;grid-template-columns:1fr;gap:20px;margin-top:20px}
    @media (min-width:880px){.grid{grid-template-columns:1fr 1fr}}
    
    /* FEEDER CARD */
    .feeder-card{background:rgba(255,255,255,.95);border-radius:20px;padding:25px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .card-title{font-size:20px;font-weight:bold;color:#1e293b;margin-bottom:15px;text-align:center}
    .aquarium-container{background:linear-gradient(180deg,#e0f2fe 0%,#bae6fd 50%,#7dd3fc 100%);border-radius:15px;padding:20px;margin-bottom:15px;position:relative;overflow:hidden;box-shadow:inset 0 2px 10px rgba(0,0,0,.1);min-height:300px}
    .fish{position:absolute;font-size:25px;animation:swim 8s infinite ease-in-out}
    @keyframes swim{0%,100%{transform:translateX(0) scaleX(1)}50%{transform:translateX(150px) scaleX(-1)}}
    .gauge-container{position:relative;width:240px;height:140px;margin:15px auto}
    .gauge-bg{width:240px;height:120px}
    .gauge-needle{position:absolute;bottom:20px;left:50%;width:3px;height:85px;background:linear-gradient(to top,#ef4444 0%,#f59e0b 50%,#22c55e 100%);transform-origin:bottom center;transform:translateX(-50%) rotate(-90deg);transition:transform .5s cubic-bezier(.4,0,.2,1);border-radius:2px;box-shadow:0 0 10px rgba(0,0,0,.3)}
    .gauge-needle::after{content:'';position:absolute;top:-6px;left:-3px;width:9px;height:9px;background:#1e293b;border-radius:50%;box-shadow:0 2px 5px rgba(0,0,0,.3)}
    .gauge-center{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);width:16px;height:16px;background:#1e293b;border-radius:50%;border:2px solid white;box-shadow:0 2px 5px rgba(0,0,0,.3);z-index:10}
    .gauge-labels{position:absolute;bottom:10px;width:100%;display:flex;justify-content:space-between;padding:0 15px;font-size:11px;font-weight:600;color:#475569}
    .status-display{text-align:center;margin:15px 0}
    .angle-display{font-size:36px;font-weight:bold;color:#1e293b;margin-bottom:8px}
    .status-text{font-size:16px;font-weight:600;padding:8px 16px;border-radius:10px;display:inline-block}
    .status-feeding{background:#dcfce7;color:#16a34a}
    .status-closed{background:#fee2e2;color:#dc2626}
    .control-section{background:white;padding:15px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    .control-title{font-size:14px;font-weight:600;color:#334155;margin-bottom:12px;text-align:center}
    input[type="range"]{width:100%;height:6px;background:linear-gradient(to right,#22c55e 0%,#f59e0b 50%,#ef4444 100%);border-radius:5px;outline:none;-webkit-appearance:none;cursor:pointer;margin:15px 0}
    input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;background:white;border:3px solid #3b82f6;border-radius:50%;cursor:pointer;box-shadow:0 2px 5px rgba(0,0,0,.2);transition:all .3s}
    input[type="range"]::-webkit-slider-thumb:hover{transform:scale(1.2);box-shadow:0 4px 10px rgba(59,130,246,.4)}
    input[type="range"]::-moz-range-thumb{width:20px;height:20px;background:white;border:3px solid #3b82f6;border-radius:50%;cursor:pointer;box-shadow:0 2px 5px rgba(0,0,0,.2)}
    .current-angle-info{margin-top:12px;padding:8px;background:#f1f5f9;border-radius:8px;text-align:center;font-size:12px;color:#64748b}
    .current-angle-value{font-weight:bold;color:#1e293b}
    .bubble{position:absolute;bottom:0;width:8px;height:8px;background:rgba(255,255,255,.5);border-radius:50%;animation:rise 4s infinite ease-in}
    @keyframes rise{0%{bottom:0;opacity:0}50%{opacity:1}100%{bottom:100%;opacity:0}}
    .bubble:nth-child(1){left:10%;animation-delay:0s}
    .bubble:nth-child(2){left:30%;animation-delay:1s;width:6px;height:6px}
    .bubble:nth-child(3){left:50%;animation-delay:2s}
    .bubble:nth-child(4){left:70%;animation-delay:.5s;width:10px;height:10px}
    .bubble:nth-child(5){left:85%;animation-delay:1.5s}
    .btn-feed{width:100%;background:linear-gradient(135deg,#22c55e 0%,#16a34a 100%);color:white;margin-top:10px}
    .btn-feed:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(34,197,94,.4)}
    
    /* MONITOR CARD */
    .monitor-card{background:rgba(17,24,51,.9);border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .monitor-card .card-title{color:var(--accent)}
    .monitor-row{display:flex;justify-content:space-between;align-items:center;margin:15px 0;padding:12px;background:rgba(255,255,255,.05);border-radius:10px}
    .monitor-label{color:var(--muted);font-size:13px}
    .monitor-value{font-size:24px;font-weight:800;color:var(--text)}
    .pill{padding:6px 12px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.12)}
    .pill.good{border-color:rgba(61,220,151,.4);color:var(--good)}
    .pill.bad{border-color:rgba(255,106,106,.4);color:var(--bad)}
    .pill.neutral{border-color:rgba(106,169,255,.35);color:var(--accent)}
    
    /* CONTROL CARDS */
    .control-card{background:rgba(17,24,51,.9);border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .control-card .card-title{color:var(--accent)}
    .control-row{display:flex;justify-content:space-between;align-items:center;margin:12px 0;gap:10px}
    select{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:var(--text);cursor:pointer}
    .btn-group{display:flex;gap:8px}
    .btn-small{padding:8px 16px;font-size:14px}
    .btn-good{background:rgba(61,220,151,.18);border:1px solid rgba(61,220,151,.35);color:var(--good)}
    .btn-good:hover{background:rgba(61,220,151,.25)}
    .btn-bad{background:rgba(255,106,106,.16);border:1px solid rgba(255,106,106,.35);color:var(--bad)}
    .btn-bad:hover{background:rgba(255,106,106,.25)}
    
    /* LOG */
    .log-card{background:rgba(17,24,51,.9);border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25);margin-top:20px}
    .log-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .log-title{font-weight:700;color:var(--accent)}
    .log{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;color:#cfe1ff;max-height:160px;overflow:auto;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.08);padding:10px;border-radius:12px}
    .btn-clear{padding:6px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:var(--text);font-size:12px}
    .btn-clear:hover{background:rgba(255,255,255,.1)}
  </style>
</head>
<body>
  <div id="loginCard" class="login-container">
    <div class="card">
      <h2>üê† ESP32 Control Panel</h2>
      <p class="subtitle">H·ªá th·ªëng ƒëi·ªÅu khi·ªÉn h·ªì c√° t·ª´ xa</p>
      <div class="input-group"><input type="email" id="email" placeholder="Email"></div>
      <div class="input-group"><input type="password" id="password" placeholder="M·∫≠t kh·∫©u"></div>
      <button id="loginBtn" class="btn-primary">ƒêƒÉng nh·∫≠p</button>
      <button id="signupBtn" class="btn-secondary">ƒêƒÉng k√Ω</button>
      <p id="loginError" class="error"></p>
    </div>
  </div>

  <div id="controlSection" class="container hidden">
    <div class="header">
      <h2>üê† ESP32 Control Panel</h2>
      <div class="user-info">
        <span id="userEmail"></span>
        <div class="device-select">
          <label style="font-size:14px">Device:</label>
          <input id="deviceId" value="device1" placeholder="device1">
        </div>
        <button id="logoutBtn" class="btn-logout">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>

    <div class="grid">
      <div class="feeder-card">
        <div class="card-title">üçΩÔ∏è H·ªá th·ªëng cho c√° ƒÉn</div>
        <div class="aquarium-container">
          <div class="fish" style="top:15px">üêü</div>
          <div class="fish" style="top:50px;animation-delay:-4s">üê†</div>
          <div class="bubble"></div><div class="bubble"></div><div class="bubble"></div><div class="bubble"></div><div class="bubble"></div>
          <div class="gauge-container">
            <svg class="gauge-bg" viewBox="0 0 240 120">
              <path d="M 20 100 A 100 100 0 0 1 220 100" fill="none" stroke="#e2e8f0" stroke-width="18" stroke-linecap="round"/>
              <path d="M 20 100 A 100 100 0 0 1 120 10" fill="none" stroke="#22c55e" stroke-width="18" stroke-linecap="round" opacity="0.3"/>
              <path d="M 120 10 A 100 100 0 0 1 220 100" fill="none" stroke="#ef4444" stroke-width="18" stroke-linecap="round" opacity="0.3"/>
            </svg>
            <div class="gauge-needle" id="gaugeNeedle"></div>
            <div class="gauge-center"></div>
            <div class="gauge-labels"><span>0¬∞</span><span>90¬∞</span><span>180¬∞</span></div>
          </div>
          <div class="status-display">
            <div class="angle-display" id="angleDisplay">90¬∞</div>
            <div class="status-text" id="statusText">ƒê√£ ƒë√≥ng</div>
          </div>
        </div>
        <div class="control-section">
          <div class="control-title">üéÆ ƒêi·ªÅu khi·ªÉn g√≥c servo</div>
          <input type="range" id="angleSlider" min="0" max="180" value="90">
          <div class="current-angle-info">G√≥c hi·ªán t·∫°i t·ª´ ESP32: <span class="current-angle-value" id="currentAngle">-</span>¬∞</div>
        </div>
        <button id="btnFeedNow" class="btn-feed">üçΩÔ∏è Cho ƒÉn ngay</button>
      </div>

      <div class="monitor-card">
        <div class="card-title">üìä Theo d√µi h·ªá th·ªëng</div>
        <div class="monitor-row">
          <div><div class="monitor-label">Nhi·ªát ƒë·ªô</div><div class="monitor-value" id="tempC">‚Äî</div></div>
          <span id="tempPill" class="pill neutral">‚Äî</span>
        </div>
        <div class="monitor-row">
          <div><div class="monitor-label">Qu·∫°t</div><div class="monitor-value" id="fanState" style="font-size:18px">‚Äî</div></div>
          <span id="fanPill" class="pill neutral">‚Äî</span>
        </div>
        <div class="monitor-row">
          <div><div class="monitor-label">B∆°m</div><div class="monitor-value" id="pumpState" style="font-size:18px">‚Äî</div></div>
          <span id="pumpPill" class="pill neutral">‚Äî</span>
        </div>
        <div class="monitor-row" style="flex-direction:column;align-items:flex-start">
          <div class="monitor-label">L·∫ßn cu·ªëi b∆°m ch·∫°y</div>
          <div id="pumpLastRun" style="color:var(--text);font-size:14px;margin-top:5px">‚Äî</div>
        </div>
      </div>

      <div class="control-card">
        <div class="card-title">üí® Qu·∫°t (AUTO / MANUAL)</div>
        <div class="control-row">
          <div><div class="monitor-label">Mode</div><select id="fanMode"><option value="auto">auto</option><option value="manual">manual</option></select></div>
        </div>
        <div class="control-row">
          <div class="monitor-label">Manual target (ch·ªâ khi mode=manual)</div>
          <div class="btn-group">
            <button id="btnFanOn" class="btn-small btn-good">ON</button>
            <button id="btnFanOff" class="btn-small btn-bad">OFF</button>
          </div>
        </div>
      </div>

      <div class="control-card">
        <div class="card-title">üíß B∆°m (AUTO / MANUAL)</div>
        <div class="control-row">
          <div><div class="monitor-label">Mode</div><select id="pumpMode"><option value="auto">auto</option><option value="manual">manual</option></select></div>
        </div>
        <div class="control-row">
          <div class="monitor-label">Manual target (ch·ªâ khi mode=manual)</div>
          <div class="btn-group">
            <button id="btnPumpOn" class="btn-small btn-good">ON</button>
            <button id="btnPumpOff" class="btn-small btn-bad">OFF</button>
          </div>
        </div>
      </div>
    </div>

    <div class="log-card">
      <div class="log-header">
        <div class="log-title">üìù Log h·ªá th·ªëng</div>
        <button class="btn-clear" id="btnClearLog">Clear</button>
      </div>
      <div id="log" class="log"></div>
    </div>
  </div>

  <script type="module">
    import{initializeApp as i}from"https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";import{getAuth as a,signInWithEmailAndPassword as s,onAuthStateChanged as o,signOut as n}from"https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";import{getDatabase as r,ref as d,onValue as l,set as c}from"https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    const h={apiKey:"AIzaSyDvASGycQeoIyR-jpU_VziKYpCX_yORxuM",authDomain:"rtos02.firebaseapp.com",databaseURL:"https://rtos02-default-rtdb.firebaseio.com",projectId:"rtos02",storageBucket:"rtos02.firebasestorage.app",messagingSenderId:"1050505054396",appId:"1:1050505054396:web:c024d53ff4218d35dfe8b9"},p=i(h),u=a(p),g=r(p),e=e=>document.getElementById(e),m=e("log");
    function b(e){m.textContent=`[${new Date().toLocaleTimeString()}] ${e}\n`+m.textContent}
    function f(e,t,a){e.classList.remove("good","bad","neutral"),e.classList.add(t),e.textContent=a}
    function v(t){e("angleDisplay").textContent=t+"¬∞",e("gaugeNeedle").style.transform=`translateX(-50%) rotate(${t-90}deg)`;const a=e("statusText");t<90?(a.textContent="üçΩÔ∏è C√° ƒëang ƒÉn",a.className="status-text status-feeding"):(a.textContent="üö´ ƒê√£ ƒë√≥ng",a.className="status-text status-closed")}
    function y(){return`devices/${e("deviceId").value.trim()||"device1"}`}
    const w=e=>`${y()}/${e}`;let x=[];
    function A(){x.forEach(e=>{try{e()}catch(e){}}),x=[]}
    function C(){A(),b(`Subscribe: ${y()}`);{const t=d(g,w("sensors/tempC")),a=l(t,t=>{const a=t.val();if(e("tempC").textContent=null==a?"‚Äî":`${Number(a).toFixed(1)}¬∞C`,"number"==typeof a)a>=27?f(e("tempPill"),"bad","HOT"):a<=24?f(e("tempPill"),"neutral","COOL"):f(e("tempPill"),"good","OK");else f(e("tempPill"),"neutral","‚Äî")},e=>b(`Error: ${e?.message||e}`));x.push(()=>a())}{const t=d(g,w("servo0/targetAngle")),a=l(t,t=>{const a=t.val();"number"==typeof a&&(e("angleSlider").value=String(a),v(a))});x.push(()=>a());const s=d(g,w("servo0/currentAngle")),o=l(s,t=>{e("currentAngle").textContent=null==t.val()?"‚Äî":String(t.val())});x.push(()=>o())}{const t=d(g,w("actuators/fan/state")),a=l(t,t=>{const a=1===t.val()||!0===t.val();e("fanState").textContent=a?"ON":"OFF",f(e("fanPill"),a?"good":"neutral",a?"RUNNING":"IDLE")});x.push(()=>a());const s=d(g,w("actuators/fan/mode")),o=l(s,t=>{e("fanMode").value="manual"===t.val()?"manual":"auto"});x.push(()=>o())}{const t=d(g,w("actuators/pump/state")),a=l(t,t=>{const a=1===t.val()||!0===t.val();e("pumpState").textContent=a?"ON":"OFF",f(e("pumpPill"),a?"good":"neutral",a?"RUNNING":"IDLE")});x.push(()=>a());const s=d(g,w("actuators/pump/mode")),o=l(s,t=>{e("pumpMode").value="manual"===t.val()?"manual":"auto"});x.push(()=>o());const n=d(g,w("actuators/pump/lastRunIso")),r=l(n,t=>{e("pumpLastRun").textContent=null==t.val()?"‚Äî":String(t.val())});x.push(()=>r())}}
    e("btnClearLog").onclick=()=>m.textContent="",e("angleSlider").addEventListener("input",()=>{const t=Number(e("angleSlider").value);v(t),c(d(g,w("servo0/targetAngle")),t),b(`Servo: ${t}¬∞`)}),e("btnFeedNow").onclick=async()=>{await c(d(g,w("feeding/feedNow")),1),b("Feed now!")},e("fanMode").addEventListener("change",async()=>{const t=e("fanMode").value;await c(d(g,w("actuators/fan/mode")),t),b(`Fan mode: ${t}`)}),e("btnFanOn").onclick=async()=>{await c(d(g,w("actuators/fan/target")),1),b("Fan: ON")},e("btnFanOff").onclick=async()=>{await c(d(g,w("actuators/fan/target")),0),b("Fan: OFF")},e("pumpMode").addEventListener("change",async()=>{const t=e("pumpMode").value;await c(d(g,w("actuators/pump/mode")),t),b(`Pump mode: ${t}`)}),e("btnPumpOn").onclick=async()=>{await c(d(g,w("actuators/pump/target")),1),b("Pump: ON")},e("btnPumpOff").onclick=async()=>{await c(d(g,w("actuators/pump/target")),0),b("Pump: OFF")},e("loginBtn").onclick=async()=>{const t=e("email").value.trim(),a=e("password").value;try{await s(u,t,a),b("Login OK")}catch(t){e("loginError").textContent=t?.message||t,b("Login failed")}},e("signupBtn").onclick=async()=>{const t=e("email").value.trim(),a=e("password").value;try{await(async(e,t,a)=>{const s=await fetch("https://identitytoolkit.googleapis.com/v1/accounts:signUp?key="+h.apiKey,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,password:a,returnSecureToken:!0})});if(!s.ok)throw new Error((await s.json()).error?.message||"Signup failed");return await s.json()})(0,t,a),await s(u,t,a),b("Signup OK")}catch(t){e("loginError").textContent=t?.message||t,b("Signup failed")}},e("logoutBtn").onclick=async()=>{await n(u),b("Logged out")},e("deviceId").addEventListener("change",()=>{u.currentUser&&C()}),o(u,t=>{t?(e("loginCard").classList.add("hidden"),e("controlSection").classList.remove("hidden"),e("userEmail").textContent=t.email,C(),b("Logged in")):(e("controlSection").classList.add("hidden"),e("loginCard").classList.remove("hidden"),A())}),v(90);
  </script>
</body>
</html>
